#!/bin/bash
# HDD Tool - Quick Linux Launcher
set -e

# Check root
if [[ $EUID -ne 0 ]]; then
    echo "‚ö†Ô∏è  Root privileges required. Restarting with sudo..."
    exec sudo "$0" "$@"
fi

# Get script directory
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN="$DIR/target/release/hdd_tool"

echo "üõ°Ô∏è  HDD Tool v0.1.0 - NIST SP 800-88 Compliant Disk Sanitization"
echo "================================================"

# Build if needed
if [[ ! -f "$BIN" ]]; then
    echo "üîß Building project..."
    cd "$DIR"
    
    if ! command -v cargo &> /dev/null; then
        echo "‚ùå Rust not found. Install: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
        exit 1
    fi
    
    # Build as original user if using sudo
    if [[ -n "$SUDO_USER" ]]; then
        sudo -u "$SUDO_USER" cargo build --release
    else
        cargo build --release
    fi
    
    if [[ ! -f "$BIN" ]]; then
        echo "‚ùå Build failed"
        exit 1
    fi
    echo "‚úÖ Build complete"
fi

# Security warning
echo "‚ö†Ô∏è  WARNING: This tool performs irreversible data destruction!"
echo "‚ö†Ô∏è  Verify target devices before proceeding!"
echo

# Run
echo "üöÄ Starting HDD Tool..."
chmod +x "$BIN"
exec "$BIN" "$@"